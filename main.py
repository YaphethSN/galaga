import math
import time
import curses
import pynput
from enum import Enum
import random
import string   

stdscr = curses.initscr()

class layout:
    def __init__(self, text):
        self.source_text = text
        self.source_array = text.split("\n")
        self.layer_visibility = [True] * len(self.source_array)
    
    def __str__(self):
        output_string = ""

        for line in self.source_array:
            output_string += line + "\n"

        return output_string

    def draw_at(self, stdscr, line_pos, column_pos):
        for index in range(len(self.source_array)):
            layer = self.source_array[index]
            if ((line_pos + index) < 0) or ((line_pos + index) >= curses.LINES) or (column_pos >= curses.COLS) or (column_pos <= -len(layer)) or not self.layer_visibility[index]:
                continue

            start_column = min(len(layer), max(0, -column_pos))
            end_column = max(0, min(curses.COLS - column_pos, len(layer)))
            # print(f"start: {start_column} end: {end_column}")

            # if len(layer) > 16:
            #     global debug_message
            #     debug_message = f"curses COLS {curses.COLS} end_column {end_column} column pos {column_pos}"

            stdscr.addstr(line_pos + index, column_pos + start_column, layer[start_column:end_column])

class vec2:
    def __init__(self, x, y):
        self.x = x
        self.y = y

    def __str__(self):
        return f"[{self.x}, {self.y}]"
    
    def add(self, other):
        if isinstance(other, vec2):
            self.x += other.x
            self.y += other.y
        else:
            self.x += other
            self.y += other
        
        return self

    def substr(self, other):
        if isinstance(other, vec2):
            self.x -= other.x
            self.y -= other.y
        else:
            self.x -= other
            self.y -= other
        
        return self

    def multiply(self, other):
        if isinstance(other, vec2):
            self.x *= other.x
            self.y *= other.y
        else:
            self.x *= other
            self.y *= other
    
        return self

    def divide(self, other):
        if isinstance(other, vec2):
            self.x /= other.x
            self.y /= other.y
        else:
            self.x /= other
            self.y /= other
        
        return self

    def calc_add(self, other):
        result = vec2(self.x, self.y)
        return result.add(other)
        
    def calc_substr(self, other):
        result = vec2(self.x, self.y)
        return result.substr(other)
        
    def calc_multiply(self, other):
        result = vec2(self.x, self.y)
        return result.multiply(other)
    
    def calc_divide(self, other):
        result = vec2(self.x, self.y)
        return result.divide(other)

    def to_int(self):
        self.x = int(round(self.x))
        self.y = int(round(self.y))
        return self
    
    def calc_to_int(self):
        result = vec2(self.x, self.y)
        return result.to_int()
    
    def length(self):
        return math.sqrt(self.x*self.x + self.y*self.y)

entity_buffer = []

class Entity:
    texture = ""
    texture_dimensions = vec2(0, 0)
    # avoid creating a shared mutable vec2 at class level
    # each Entity should have its own `position` instance
    position = None
    state_tick = 0
    bulletproof = True
    identification = ""
    entity_buffer_index = 0
    health = 1

    def __init__(self, x = 0, y = 0):
        # create an instance-local position vector so instances don't share state
        self.position = vec2(x, y)
        self.layout = layout(self.texture)
        self.identification = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(10))
        self.entity_buffer_index = len(entity_buffer)
        entity_buffer.append(self)
    
    def is_colliding(self, other_entity):
        x_min_distance = (other_entity.texture_dimensions.x + self.texture_dimensions.x)/2
        y_min_distance = (other_entity.texture_dimensions.y + self.texture_dimensions.y)/2
        x_distance = other_entity.position.x - self.position.x
        y_distance = other_entity.position.y - self.position.y

        if x_min_distance >= abs(x_distance) and y_min_distance >= abs(y_distance):
            return True
#    ^
#  |/.\|
# |/_^_\|
class Starfighter(Entity):
    texture ="""   ^   
 |/.\| 
|/_^_\|"""
    texture_dimensions = vec2(7, 3)
    bulletproof = False
    health = 10

class Bullet(Entity):
    texture = """|""" 
    texture_dimensions = vec2(1, 1)
    pointing_up = False # false for pointing down, aka the enemy

class EnemyBehavior(Enum):
    IN_PATH = "Following a predetermined path"
    GOING_TO_LINE = "Going to its place"
    ATTACKING = "Is currently attacking"

paths = [
    {
        "speed": 2,
        "path": [vec2(0.0006527415143603133, 0.6771488469601677),vec2(0.0006527415143603133, 0.6771488469601677),vec2(0.0032637075718015664, 0.6792452830188679),vec2(0.00587467362924282, 0.6823899371069182),vec2(0.009138381201044387, 0.6844863731656184),vec2(0.011096605744125326, 0.6844863731656184),vec2(0.014360313315926894, 0.6855345911949685),vec2(0.016318537859007835, 0.6865828092243187),vec2(0.018276762402088774, 0.6886792452830188),vec2(0.020887728459530026, 0.689727463312369),vec2(0.022845953002610966, 0.689727463312369),vec2(0.024804177545691905, 0.6907756813417191),vec2(0.02610966057441253, 0.6928721174004193),vec2(0.02741514360313316, 0.6928721174004193),vec2(0.028720626631853787, 0.6939203354297694),vec2(0.030026109660574413, 0.6949685534591195),vec2(0.03198433420365535, 0.6960167714884696),vec2(0.03328981723237598, 0.6970649895178197),vec2(0.034595300261096605, 0.6981132075471698),vec2(0.03655352480417755, 0.69916142557652),vec2(0.03720626631853786, 0.70020964360587),vec2(0.037859007832898174, 0.7012578616352201),vec2(0.0391644908616188, 0.7023060796645703),vec2(0.03981723237597911, 0.7033542976939203),vec2(0.041122715404699736, 0.7033542976939203),vec2(0.04242819843342036, 0.7044025157232704),vec2(0.04503916449086162, 0.7064989517819706),vec2(0.04699738903394256, 0.7075471698113207),vec2(0.0489556135770235, 0.7075471698113207),vec2(0.05026109660574413, 0.709643605870021),vec2(0.05287206266318538, 0.7117400419287212),vec2(0.054177545691906005, 0.7117400419287212),vec2(0.05483028720626632, 0.7127882599580713),vec2(0.05548302872062663, 0.7127882599580713),vec2(0.05613577023498695, 0.7138364779874213),vec2(0.057441253263707574, 0.7148846960167715),vec2(0.058093994778067884, 0.7148846960167715),vec2(0.0587467362924282, 0.7159329140461216),vec2(0.06005221932114883, 0.7169811320754716),vec2(0.06266318537859007, 0.7190775681341719),vec2(0.06462140992167102, 0.720125786163522),vec2(0.06657963446475196, 0.7211740041928721),vec2(0.06984334203655353, 0.7222222222222222),vec2(0.07180156657963446, 0.7232704402515723),vec2(0.07441253263707572, 0.7232704402515723),vec2(0.07506527415143603, 0.7243186582809225),vec2(0.07702349869451697, 0.7253668763102725),vec2(0.0783289817232376, 0.7264150943396226),vec2(0.07963446475195822, 0.7264150943396226),vec2(0.08028720626631854, 0.7274633123689728),vec2(0.08159268929503917, 0.7274633123689728),vec2(0.08159268929503917, 0.7285115303983228),vec2(0.08224543080939947, 0.7285115303983228),vec2(0.08420365535248042, 0.7285115303983228),vec2(0.08485639686684072, 0.7295597484276729),vec2(0.08550913838120104, 0.7306079664570231),vec2(0.08681462140992167, 0.7306079664570231),vec2(0.08877284595300261, 0.7306079664570231),vec2(0.09138381201044386, 0.7306079664570231),vec2(0.09530026109660575, 0.7316561844863732),vec2(0.09725848563968668, 0.7316561844863732),vec2(0.09986945169712794, 0.7316561844863732),vec2(0.10182767624020887, 0.7316561844863732),vec2(0.10378590078328982, 0.7316561844863732),vec2(0.10704960835509138, 0.7327044025157232),vec2(0.10835509138381201, 0.7327044025157232),vec2(0.11031331592689295, 0.7327044025157232),vec2(0.1129242819843342, 0.7327044025157232),vec2(0.11488250652741515, 0.7327044025157232),vec2(0.1174934725848564, 0.7327044025157232),vec2(0.11945169712793734, 0.7327044025157232),vec2(0.12140992167101827, 0.7327044025157232),vec2(0.12402088772845953, 0.7327044025157232),vec2(0.12924281984334204, 0.7327044025157232),vec2(0.13054830287206268, 0.7327044025157232),vec2(0.13185378590078328, 0.7327044025157232),vec2(0.13315926892950392, 0.7327044025157232),vec2(0.13577023498694518, 0.7316561844863732),vec2(0.1377284595300261, 0.7316561844863732),vec2(0.14033942558746737, 0.7316561844863732),vec2(0.141644908616188, 0.7306079664570231),vec2(0.1429503916449086, 0.7295597484276729),vec2(0.14556135770234988, 0.7285115303983228),vec2(0.1481723237597911, 0.7264150943396226),vec2(0.1514360313315927, 0.7243186582809225),vec2(0.15469973890339425, 0.7222222222222222),vec2(0.1566579634464752, 0.720125786163522),vec2(0.16057441253263707, 0.7190775681341719),vec2(0.1618798955613577, 0.7190775681341719),vec2(0.16383812010443866, 0.7180293501048218),vec2(0.16514360313315926, 0.7159329140461216),vec2(0.1671018276762402, 0.7159329140461216),vec2(0.16775456919060053, 0.7148846960167715),vec2(0.16971279373368145, 0.7138364779874213),vec2(0.17036553524804177, 0.7138364779874213),vec2(0.1716710182767624, 0.7127882599580713),vec2(0.17232375979112272, 0.7117400419287212),vec2(0.17297650130548303, 0.7117400419287212),vec2(0.17493472584856398, 0.710691823899371),vec2(0.17558746736292427, 0.709643605870021),vec2(0.1768929503916449, 0.7085953878406709),vec2(0.17819843342036554, 0.7075471698113207),vec2(0.1801566579634465, 0.7054507337526206),vec2(0.1814621409921671, 0.7044025157232704),vec2(0.18276762402088773, 0.7023060796645703),vec2(0.1860313315926893, 0.7012578616352201),vec2(0.18864229765013055, 0.6970649895178197),vec2(0.1906005221932115, 0.6960167714884696),vec2(0.19321148825065274, 0.6939203354297694),vec2(0.19843342036553524, 0.689727463312369),vec2(0.2010443864229765, 0.6876310272536688),vec2(0.20234986945169714, 0.6865828092243187),vec2(0.20496083550913838, 0.6844863731656184),vec2(0.206266318537859, 0.6834381551362684),vec2(0.20757180156657964, 0.6823899371069182),vec2(0.20887728459530025, 0.6802935010482181),vec2(0.21018276762402088, 0.6792452830188679),vec2(0.21148825065274152, 0.6781970649895178),vec2(0.21214099216710183, 0.6761006289308176),vec2(0.21279373368146215, 0.6750524109014675),vec2(0.2154046997389034, 0.6740041928721174),vec2(0.2160574412532637, 0.6719077568134172),vec2(0.21801566579634465, 0.6677148846960168),vec2(0.22193211488250653, 0.6614255765199162),vec2(0.22323759791122716, 0.6572327044025157),vec2(0.22519582245430808, 0.6530398322851153),vec2(0.22650130548302871, 0.6488469601677149),vec2(0.22845953002610966, 0.6436058700209644),vec2(0.22911227154046998, 0.640461215932914),vec2(0.2304177545691906, 0.6373165618448637),vec2(0.23172323759791122, 0.6331236897274634),vec2(0.23302872062663185, 0.6289308176100629),vec2(0.23302872062663185, 0.6268343815513627),vec2(0.2349869451697128, 0.6226415094339622),vec2(0.23563968668407312, 0.6194968553459119),vec2(0.23694516971279372, 0.6121593291404612),vec2(0.23694516971279372, 0.6090146750524109),vec2(0.23890339425587467, 0.5985324947589099),vec2(0.23890339425587467, 0.5953878406708596),vec2(0.2402088772845953, 0.590146750524109),vec2(0.24086161879895562, 0.5870020964360587),vec2(0.24151436031331594, 0.5838574423480084),vec2(0.24151436031331594, 0.5817610062893082),vec2(0.24151436031331594, 0.5796645702306079),vec2(0.24216710182767623, 0.5765199161425576),vec2(0.24216710182767623, 0.5733752620545073),vec2(0.24216710182767623, 0.5712788259958071),vec2(0.24216710182767623, 0.5691823899371069),vec2(0.24281984334203655, 0.5639412997903563),vec2(0.24347258485639686, 0.559748427672956),vec2(0.24347258485639686, 0.5545073375262054),vec2(0.24347258485639686, 0.5513626834381551),vec2(0.24347258485639686, 0.5450733752620545),vec2(0.24347258485639686, 0.5419287211740041),vec2(0.24347258485639686, 0.5387840670859538),vec2(0.24347258485639686, 0.5356394129979035),vec2(0.24347258485639686, 0.5335429769392034),vec2(0.24347258485639686, 0.5314465408805031),vec2(0.24347258485639686, 0.5303983228511531),vec2(0.24347258485639686, 0.5262054507337526),vec2(0.24347258485639686, 0.5241090146750524),vec2(0.24347258485639686, 0.5188679245283019),vec2(0.24281984334203655, 0.5146750524109015),vec2(0.24216710182767623, 0.5115303983228512),vec2(0.24151436031331594, 0.5062893081761006),vec2(0.24151436031331594, 0.5010482180293501),vec2(0.24086161879895562, 0.4979035639412998),vec2(0.239556135770235, 0.4947589098532495),vec2(0.23890339425587467, 0.4916142557651992),vec2(0.23890339425587467, 0.48951781970649894),vec2(0.23759791122715404, 0.4863731656184486),vec2(0.23694516971279372, 0.48427672955974843),vec2(0.23694516971279372, 0.4832285115303983),vec2(0.23563968668407312, 0.4790356394129979),vec2(0.2349869451697128, 0.4769392033542977),vec2(0.23368146214099217, 0.4758909853249476),vec2(0.23302872062663185, 0.47379454926624737),vec2(0.23172323759791122, 0.4716981132075472),vec2(0.2310704960835509, 0.469601677148847),vec2(0.22845953002610966, 0.46540880503144655),vec2(0.22650130548302871, 0.4612159329140461),vec2(0.2245430809399478, 0.4591194968553459),vec2(0.22323759791122716, 0.4580712788259958),vec2(0.22258485639686684, 0.4559748427672956),vec2(0.2206266318537859, 0.4528301886792453),vec2(0.21997389033942558, 0.45073375262054505),vec2(0.21866840731070497, 0.44863731656184486),vec2(0.2160574412532637, 0.44549266247379454),vec2(0.21475195822454307, 0.44339622641509435),vec2(0.21279373368146215, 0.44025157232704404),vec2(0.21018276762402088, 0.4371069182389937),vec2(0.20822454308093996, 0.4360587002096436),vec2(0.2056135770234987, 0.4329140461215933),vec2(0.20430809399477806, 0.4308176100628931),vec2(0.20234986945169714, 0.42872117400419285),vec2(0.2010443864229765, 0.4276729559748428),vec2(0.19908616187989556, 0.42662473794549266),vec2(0.19778067885117492, 0.42557651991614254),vec2(0.19647519582245432, 0.42557651991614254),vec2(0.19451697127937337, 0.42452830188679247),vec2(0.19255874673629242, 0.4224318658280922),vec2(0.1912532637075718, 0.4224318658280922),vec2(0.18798955613577023, 0.42138364779874216),vec2(0.18472584856396868, 0.42138364779874216),vec2(0.17819843342036554, 0.42138364779874216),vec2(0.17232375979112272, 0.42138364779874216),vec2(0.16775456919060053, 0.42138364779874216),vec2(0.16383812010443866, 0.42452830188679247),vec2(0.16057441253263707, 0.42557651991614254),vec2(0.15796344647519583, 0.42557651991614254),vec2(0.1566579634464752, 0.42662473794549266),vec2(0.15404699738903394, 0.4276729559748428),vec2(0.15274151436031333, 0.42872117400419285),vec2(0.1514360313315927, 0.42872117400419285),vec2(0.14947780678851175, 0.429769392033543),vec2(0.1475195822454308, 0.43186582809224316),vec2(0.14556135770234988, 0.4339622641509434),vec2(0.141644908616188, 0.4371069182389937),vec2(0.13903394255874674, 0.44025157232704404),vec2(0.13577023498694518, 0.4444444444444444),vec2(0.13315926892950392, 0.44654088050314467),vec2(0.13120104438642297, 0.44863731656184486),vec2(0.12989556135770236, 0.449685534591195),vec2(0.12859007832898173, 0.45178197064989517),vec2(0.1279373368146214, 0.45387840670859536),vec2(0.1272845953002611, 0.4549266247379455),vec2(0.12597911227154046, 0.4559748427672956),vec2(0.12532637075718014, 0.4580712788259958),vec2(0.12532637075718014, 0.4591194968553459),vec2(0.12467362924281984, 0.46016771488469604),vec2(0.12402088772845953, 0.46226415094339623),vec2(0.1227154046997389, 0.4643605870020964),vec2(0.12140992167101827, 0.46750524109014674),vec2(0.12010443864229765, 0.47064989517819705),vec2(0.1181462140992167, 0.4758909853249476),vec2(0.1181462140992167, 0.4779874213836478),vec2(0.1174934725848564, 0.4811320754716981),vec2(0.11684073107049608, 0.48427672955974843),vec2(0.11618798955613577, 0.48532494758909855),vec2(0.11553524804177545, 0.4863731656184486),vec2(0.11488250652741515, 0.48951781970649894),vec2(0.11422976501305483, 0.49266247379454925),vec2(0.11422976501305483, 0.4968553459119497),vec2(0.11357702349869452, 0.5),vec2(0.1129242819843342, 0.5031446540880503),vec2(0.1122715404699739, 0.5052410901467506),vec2(0.1122715404699739, 0.5073375262054507),vec2(0.11161879895561358, 0.510482180293501),vec2(0.11096605744125326, 0.5115303983228512),vec2(0.11096605744125326, 0.5125786163522013),vec2(0.11031331592689295, 0.5146750524109015),vec2(0.11031331592689295, 0.5178197064989518),vec2(0.11031331592689295, 0.5209643605870021),vec2(0.11031331592689295, 0.5220125786163522),vec2(0.10966057441253264, 0.5241090146750524),vec2(0.10966057441253264, 0.5293501048218029),vec2(0.10966057441253264, 0.5335429769392034),vec2(0.10966057441253264, 0.539832285115304),vec2(0.10966057441253264, 0.5440251572327044),vec2(0.10966057441253264, 0.550314465408805),vec2(0.10966057441253264, 0.5555555555555556),vec2(0.10966057441253264, 0.5576519916142557),vec2(0.10966057441253264, 0.559748427672956),vec2(0.10966057441253264, 0.5618448637316562),vec2(0.10966057441253264, 0.5639412997903563),vec2(0.11031331592689295, 0.5670859538784067),vec2(0.11031331592689295, 0.570230607966457),vec2(0.11096605744125326, 0.5723270440251572),vec2(0.11161879895561358, 0.5754716981132075),vec2(0.1122715404699739, 0.5775681341719078),vec2(0.1122715404699739, 0.5796645702306079),vec2(0.11357702349869452, 0.5838574423480084),vec2(0.11422976501305483, 0.5870020964360587),vec2(0.11422976501305483, 0.589098532494759),vec2(0.11488250652741515, 0.5932914046121593),vec2(0.11618798955613577, 0.5953878406708596),vec2(0.11684073107049608, 0.5974842767295597),vec2(0.1174934725848564, 0.59958071278826),vec2(0.11879895561357702, 0.6037735849056604),vec2(0.12206266318537859, 0.6079664570230608),vec2(0.12597911227154046, 0.6132075471698113),vec2(0.12989556135770236, 0.6163522012578616),vec2(0.13315926892950392, 0.6194968553459119),vec2(0.13642297650130547, 0.6215932914046122),vec2(0.13838120104438642, 0.6247379454926625),vec2(0.13968668407310705, 0.6268343815513627),vec2(0.1409921671018277, 0.6278825995807128),vec2(0.1422976501305483, 0.6289308176100629),vec2(0.1429503916449086, 0.629979035639413),vec2(0.14425587467362924, 0.6310272536687631),vec2(0.14490861618798956, 0.6320754716981132),vec2(0.1462140992167102, 0.6341719077568134),vec2(0.1475195822454308, 0.6352201257861635),vec2(0.1481723237597911, 0.6362683438155137),vec2(0.14947780678851175, 0.6373165618448637),vec2(0.15013054830287206, 0.6383647798742138),vec2(0.1514360313315927, 0.640461215932914),vec2(0.15274151436031333, 0.6415094339622641),vec2(0.15274151436031333, 0.6425576519916143),vec2(0.15339425587467362, 0.6436058700209644),vec2(0.15404699738903394, 0.6446540880503144),vec2(0.15535248041775457, 0.6457023060796646),vec2(0.15731070496083552, 0.6477987421383647),vec2(0.15861618798955612, 0.649895178197065),vec2(0.15992167101827676, 0.6509433962264151),vec2(0.16253263707571802, 0.6530398322851153),vec2(0.16514360313315926, 0.6551362683438156),vec2(0.1671018276762402, 0.6551362683438156),vec2(0.16971279373368145, 0.6561844863731656),vec2(0.17036553524804177, 0.6561844863731656),vec2(0.1716710182767624, 0.6561844863731656),vec2(0.17232375979112272, 0.6572327044025157),vec2(0.17297650130548303, 0.6572327044025157),vec2(0.17362924281984335, 0.6572327044025157),vec2(0.17428198433420367, 0.6582809224318659),vec2(0.17558746736292427, 0.6582809224318659),vec2(0.1762402088772846, 0.6593291404612159),vec2(0.17754569190600522, 0.6593291404612159),vec2(0.1801566579634465, 0.660377358490566),vec2(0.18472584856396868, 0.660377358490566),vec2(0.1906005221932115, 0.6614255765199162),vec2(0.19516971279373369, 0.6614255765199162),vec2(0.2003916449086162, 0.6624737945492662),vec2(0.20234986945169714, 0.6624737945492662),vec2(0.20496083550913838, 0.6635220125786163),vec2(0.206266318537859, 0.6635220125786163),vec2(0.20822454308093996, 0.6635220125786163),vec2(0.20887728459530025, 0.6635220125786163),vec2(0.21148825065274152, 0.6635220125786163),vec2(0.21344647519582247, 0.6645702306079665),vec2(0.2160574412532637, 0.6645702306079665),vec2(0.21801566579634465, 0.6645702306079665),vec2(0.2258485639686684, 0.6645702306079665),vec2(0.23237597911227154, 0.6645702306079665),vec2(0.2349869451697128, 0.6645702306079665),vec2(0.239556135770235, 0.6645702306079665),vec2(0.24216710182767623, 0.6645702306079665),vec2(0.24412532637075718, 0.6645702306079665),vec2(0.24608355091383813, 0.6645702306079665),vec2(0.24804177545691905, 0.6645702306079665),vec2(0.24934725848563968, 0.6645702306079665),vec2(0.2506527415143603, 0.6645702306079665),vec2(0.25130548302872063, 0.6645702306079665),vec2(0.25326370757180156, 0.6645702306079665),vec2(0.2558746736292428, 0.6645702306079665),vec2(0.25783289817232374, 0.6645702306079665),vec2(0.2597911227154047, 0.6645702306079665),vec2(0.26109660574412535, 0.6645702306079665),vec2(0.26240208877284593, 0.6635220125786163),vec2(0.26370757180156656, 0.6624737945492662),vec2(0.2643603133159269, 0.6624737945492662),vec2(0.2650130548302872, 0.6614255765199162),vec2(0.2669712793733681, 0.660377358490566),vec2(0.26762402088772846, 0.6593291404612159),vec2(0.2689295039164491, 0.6582809224318659),vec2(0.27023498694516973, 0.6572327044025157),vec2(0.27088772845953, 0.6572327044025157),vec2(0.27219321148825065, 0.6561844863731656),vec2(0.2734986945169713, 0.6551362683438156),vec2(0.2748041775456919, 0.6551362683438156),vec2(0.27610966057441255, 0.6530398322851153),vec2(0.2774151436031332, 0.6519916142557652),vec2(0.2793733681462141, 0.6488469601677149),vec2(0.28133159268929503, 0.6477987421383647),vec2(0.283289817232376, 0.6446540880503144),vec2(0.28655352480417756, 0.6425576519916143),vec2(0.2891644908616188, 0.639412997903564),vec2(0.29177545691906004, 0.6373165618448637),vec2(0.293733681462141, 0.6352201257861635),vec2(0.2943864229765013, 0.6352201257861635),vec2(0.29569190600522194, 0.6331236897274634),vec2(0.29699738903394257, 0.6320754716981132),vec2(0.29765013054830286, 0.629979035639413),vec2(0.2989556135770235, 0.629979035639413),vec2(0.29960835509138384, 0.6289308176100629),vec2(0.3009138381201044, 0.6268343815513627),vec2(0.30156657963446476, 0.6268343815513627),vec2(0.30221932114882505, 0.6247379454926625),vec2(0.304177545691906, 0.6215932914046122),vec2(0.30548302872062666, 0.6194968553459119),vec2(0.30809399477806787, 0.6163522012578616),vec2(0.31005221932114885, 0.6111111111111112),vec2(0.3133159268929504, 0.6069182389937107),vec2(0.31723237597911225, 0.5985324947589099),vec2(0.3178851174934726, 0.5964360587002097),vec2(0.3198433420365535, 0.5922431865828093),vec2(0.32049608355091386, 0.5911949685534591),vec2(0.32114882506527415, 0.589098532494759),vec2(0.3218015665796345, 0.5870020964360587),vec2(0.32310704960835507, 0.5849056603773585),vec2(0.3237597911227154, 0.5838574423480084),vec2(0.32571801566579633, 0.5796645702306079),vec2(0.32702349869451697, 0.5775681341719078),vec2(0.3276762402088773, 0.5765199161425576),vec2(0.3289817232375979, 0.5733752620545073),vec2(0.3302872062663185, 0.5691823899371069),vec2(0.3302872062663185, 0.5681341719077568),vec2(0.3322454308093995, 0.5628930817610063),vec2(0.3328981723237598, 0.560796645702306),vec2(0.3342036553524804, 0.5555555555555556),vec2(0.33550913838120106, 0.550314465408805),vec2(0.337467362924282, 0.5471698113207547),vec2(0.3387728459530026, 0.5366876310272537),vec2(0.3394255874673629, 0.5335429769392034),vec2(0.34007832898172324, 0.5293501048218029),vec2(0.34073107049608353, 0.5262054507337526),vec2(0.34203655352480417, 0.5220125786163522),vec2(0.3433420365535248, 0.5167714884696016),vec2(0.34464751958224543, 0.5125786163522013),vec2(0.34595300261096606, 0.5083857442348009),vec2(0.34856396866840733, 0.4989517819706499),vec2(0.35052219321148825, 0.4937106918238994),vec2(0.3518276762402089, 0.49056603773584906),vec2(0.3531331592689295, 0.4832285115303983),vec2(0.35443864229765015, 0.4769392033542977),vec2(0.35574412532637073, 0.4727463312368973),vec2(0.3563968668407311, 0.469601677148847),vec2(0.358355091383812, 0.46645702306079667),vec2(0.35966057441253263, 0.46226415094339623),vec2(0.3622715404699739, 0.4580712788259958),vec2(0.36553524804177545, 0.45178197064989517),vec2(0.3681462140992167, 0.44549266247379454),vec2(0.370757180156658, 0.4381551362683438),vec2(0.3727154046997389, 0.43186582809224316),vec2(0.3733681462140992, 0.42872117400419285),vec2(0.37467362924281983, 0.42452830188679247),vec2(0.37532637075718017, 0.42138364779874216),vec2(0.37597911227154046, 0.4171907756813417)]
    }, {
        "speed": 1,
        "path": [vec2(0.9994769874476988, 0.4716981132075472),vec2(0.9968619246861925, 0.47379454926624737),vec2(0.9911087866108786, 0.4779874213836478),vec2(0.9832635983263598, 0.48427672955974843),vec2(0.9743723849372385, 0.4937106918238994),vec2(0.9680962343096234, 0.5),vec2(0.9602510460251046, 0.5073375262054507),vec2(0.9534518828451883, 0.5136268343815513),vec2(0.9450836820083682, 0.5230607966457023),vec2(0.9414225941422594, 0.5262054507337526),vec2(0.9377615062761506, 0.5303983228511531),vec2(0.9335774058577406, 0.5335429769392034),vec2(0.9293933054393305, 0.5356394129979035),vec2(0.9231171548117155, 0.5408805031446541),vec2(0.9189330543933054, 0.5440251572327044),vec2(0.9157949790794979, 0.5461215932914046),vec2(0.9126569037656904, 0.550314465408805),vec2(0.9079497907949791, 0.5545073375262054),vec2(0.9011506276150628, 0.560796645702306),vec2(0.8969665271966527, 0.5628930817610063),vec2(0.8943514644351465, 0.5649895178197065),vec2(0.891213389121339, 0.5660377358490566),vec2(0.8891213389121339, 0.5660377358490566),vec2(0.8854602510460251, 0.5691823899371069),vec2(0.8817991631799164, 0.570230607966457),vec2(0.8786610878661087, 0.570230607966457),vec2(0.875, 0.570230607966457),vec2(0.8723849372384938, 0.5712788259958071),vec2(0.8676778242677824, 0.5712788259958071),vec2(0.8640167364016736, 0.5712788259958071),vec2(0.8593096234309623, 0.5723270440251572),vec2(0.8540794979079498, 0.5744234800838575),vec2(0.8493723849372385, 0.5754716981132075),vec2(0.8430962343096234, 0.5786163522012578),vec2(0.8389121338912134, 0.5807127882599581),vec2(0.8347280334728033, 0.5807127882599581),vec2(0.8294979079497908, 0.5807127882599581),vec2(0.823744769874477, 0.5817610062893082),vec2(0.8179916317991632, 0.5828092243186582),vec2(0.8143305439330544, 0.5838574423480084),vec2(0.8101464435146444, 0.5838574423480084),vec2(0.8049163179916318, 0.5849056603773585),vec2(0.799163179916318, 0.5849056603773585),vec2(0.7934100418410042, 0.5849056603773585),vec2(0.7902719665271967, 0.5849056603773585),vec2(0.7866108786610879, 0.5849056603773585),vec2(0.7829497907949791, 0.5849056603773585),vec2(0.7782426778242678, 0.5838574423480084),vec2(0.7756276150627615, 0.5828092243186582),vec2(0.772489539748954, 0.5807127882599581),vec2(0.7698744769874477, 0.5786163522012578),vec2(0.7677824267782427, 0.5765199161425576),vec2(0.7651673640167364, 0.5744234800838575),vec2(0.7641213389121339, 0.5723270440251572),vec2(0.7620292887029289, 0.5691823899371069),vec2(0.7604602510460251, 0.5660377358490566),vec2(0.7588912133891214, 0.5628930817610063),vec2(0.7562761506276151, 0.5576519916142557),vec2(0.75418410041841, 0.5534591194968553),vec2(0.752092050209205, 0.549266247379455),vec2(0.7505230125523012, 0.5461215932914046),vec2(0.7484309623430963, 0.5419287211740041),vec2(0.7447698744769874, 0.5314465408805031),vec2(0.7426778242677824, 0.5230607966457023),vec2(0.7405857740585774, 0.5167714884696016),vec2(0.7395397489539749, 0.510482180293501),vec2(0.7384937238493724, 0.5041928721174004),vec2(0.7374476987447699, 0.4989517819706499),vec2(0.7358786610878661, 0.49266247379454925),vec2(0.7343096234309623, 0.48742138364779874),vec2(0.7332635983263598, 0.4811320754716981),vec2(0.7311715481171548, 0.4716981132075472),vec2(0.7306485355648535, 0.46540880503144655),vec2(0.729602510460251, 0.46016771488469604),vec2(0.729602510460251, 0.4549266247379455),vec2(0.7290794979079498, 0.449685534591195),vec2(0.7285564853556485, 0.44025157232704404),vec2(0.7285564853556485, 0.43186582809224316),vec2(0.7285564853556485, 0.42138364779874216),vec2(0.7285564853556485, 0.4140461215932914),vec2(0.729602510460251, 0.4056603773584906),vec2(0.729602510460251, 0.40041928721174),vec2(0.7306485355648535, 0.39622641509433965),vec2(0.7322175732217573, 0.389937106918239),vec2(0.733786610878661, 0.38155136268343814),vec2(0.7343096234309623, 0.37735849056603776),vec2(0.7364016736401674, 0.3689727463312369),vec2(0.7379707112970711, 0.35953878406708595),vec2(0.7384937238493724, 0.3522012578616352),vec2(0.7395397489539749, 0.3480083857442348),vec2(0.7405857740585774, 0.3417190775681342),vec2(0.7432008368200836, 0.33438155136268344),vec2(0.7442468619246861, 0.3312368972746331),vec2(0.7463389121338913, 0.3270440251572327),vec2(0.7484309623430963, 0.32075471698113206),vec2(0.7510460251046025, 0.31446540880503143),vec2(0.7547071129707112, 0.3039832285115304),vec2(0.7562761506276151, 0.3008385744234801),vec2(0.7578451882845189, 0.2976939203354298),vec2(0.7599372384937239, 0.2945492662473795),vec2(0.7630753138075314, 0.28721174004192873),vec2(0.7693514644351465, 0.27568134171907754),vec2(0.7751046025104602, 0.2672955974842767),vec2(0.7808577405857741, 0.259958071278826),vec2(0.7839958158995816, 0.2557651991614256),vec2(0.7881799163179917, 0.25157232704402516),vec2(0.7965481171548117, 0.24633123689727462),vec2(0.803347280334728, 0.24213836477987422),vec2(0.8096234309623431, 0.240041928721174),vec2(0.8138075313807531, 0.2379454926624738),vec2(0.8174686192468619, 0.2358490566037736),vec2(0.8284518828451883, 0.23375262054507337),vec2(0.8352510460251046, 0.23375262054507337),vec2(0.8404811715481172, 0.23375262054507337),vec2(0.8441422594142259, 0.23375262054507337),vec2(0.8498953974895398, 0.23375262054507337),vec2(0.854602510460251, 0.23375262054507337),vec2(0.8593096234309623, 0.23375262054507337),vec2(0.8634937238493724, 0.23375262054507337),vec2(0.8666317991631799, 0.2358490566037736),vec2(0.8692468619246861, 0.23689727463312368),vec2(0.872907949790795, 0.240041928721174),vec2(0.877092050209205, 0.24423480083857443),vec2(0.8797071129707112, 0.24633123689727462),vec2(0.8833682008368201, 0.25052410901467503),vec2(0.8891213389121339, 0.2589098532494759),vec2(0.8917364016736402, 0.2641509433962264),vec2(0.893305439330544, 0.2693920335429769),vec2(0.8959205020920502, 0.27358490566037735),vec2(0.8990585774058577, 0.27882599580712786),vec2(0.9048117154811716, 0.2914046121593291),vec2(0.9105648535564853, 0.30922431865828093),vec2(0.9131799163179917, 0.3218029350104822),vec2(0.9147489539748954, 0.330188679245283),vec2(0.9178870292887029, 0.3385744234800839),vec2(0.9210251046025104, 0.35744234800838576),vec2(0.922071129707113, 0.3689727463312369),vec2(0.9231171548117155, 0.38155136268343814),vec2(0.9231171548117155, 0.3888888888888889),vec2(0.9236401673640168, 0.39622641509433965),vec2(0.924163179916318, 0.4077568134171908),vec2(0.924163179916318, 0.4171907756813417),vec2(0.924163179916318, 0.42348008385744235),vec2(0.924163179916318, 0.43186582809224316),vec2(0.9236401673640168, 0.4381551362683438),vec2(0.9225941422594143, 0.44654088050314467),vec2(0.9215481171548117, 0.4549266247379455),vec2(0.9194560669456067, 0.46540880503144655),vec2(0.9173640167364017, 0.4748427672955975),vec2(0.9152719665271967, 0.4832285115303983),vec2(0.9142259414225942, 0.4916142557651992),vec2(0.9137029288702929, 0.4968553459119497),vec2(0.9126569037656904, 0.5),vec2(0.9110878661087866, 0.5041928721174004),vec2(0.9095188284518828, 0.5094339622641509),vec2(0.9069037656903766, 0.5167714884696016),vec2(0.9053347280334728, 0.5230607966457023),vec2(0.9037656903765691, 0.5272536687631028),vec2(0.9021966527196653, 0.5345911949685535),vec2(0.8990585774058577, 0.5429769392033543),vec2(0.8938284518828452, 0.5513626834381551),vec2(0.8865062761506276, 0.560796645702306),vec2(0.8812761506276151, 0.5681341719077568),vec2(0.8760460251046025, 0.5786163522012578),vec2(0.8666317991631799, 0.5943396226415094),vec2(0.8608786610878661, 0.6027253668763103),vec2(0.8561715481171548, 0.6090146750524109),vec2(0.8530334728033473, 0.6121593291404612),vec2(0.8498953974895398, 0.6142557651991615),vec2(0.8425732217573222, 0.6153039832285115),vec2(0.8362970711297071, 0.6184486373165619),vec2(0.8294979079497908, 0.6184486373165619),vec2(0.8263598326359832, 0.6194968553459119),vec2(0.8226987447698745, 0.6194968553459119),vec2(0.8169456066945606, 0.6194968553459119),vec2(0.8111924686192469, 0.6194968553459119),vec2(0.8059623430962343, 0.6194968553459119),vec2(0.8017782426778243, 0.6194968553459119),vec2(0.7981171548117155, 0.6194968553459119),vec2(0.7918410041841004, 0.6163522012578616),vec2(0.7866108786610879, 0.6142557651991615),vec2(0.7819037656903766, 0.6121593291404612),vec2(0.7777196652719666, 0.610062893081761),vec2(0.7735355648535565, 0.6069182389937107),vec2(0.770397489539749, 0.6048218029350105),vec2(0.7672594142259415, 0.6016771488469602),vec2(0.7620292887029289, 0.5953878406708596),vec2(0.7578451882845189, 0.5922431865828093),vec2(0.7515690376569037, 0.5859538784067087),vec2(0.7484309623430963, 0.5817610062893082),vec2(0.7452928870292888, 0.5786163522012578),vec2(0.7432008368200836, 0.5754716981132075),vec2(0.7395397489539749, 0.570230607966457),vec2(0.7343096234309623, 0.5618448637316562),vec2(0.7306485355648535, 0.5555555555555556),vec2(0.7280334728033473, 0.550314465408805),vec2(0.725418410041841, 0.5450733752620545),vec2(0.7238493723849372, 0.5419287211740041),vec2(0.7212343096234309, 0.5345911949685535),vec2(0.7207112970711297, 0.5314465408805031),vec2(0.7201882845188284, 0.5272536687631028),vec2(0.7191422594142259, 0.5251572327044025),vec2(0.7175732217573222, 0.5209643605870021),vec2(0.7160041841004184, 0.5125786163522013),vec2(0.7149581589958159, 0.5073375262054507),vec2(0.7139121338912134, 0.5020964360587002),vec2(0.7123430962343096, 0.4937106918238994),vec2(0.7107740585774058, 0.4863731656184486),vec2(0.7086820083682008, 0.4790356394129979),vec2(0.7081589958158996, 0.4748427672955975),vec2(0.7065899581589958, 0.47064989517819705),vec2(0.7050209205020921, 0.46540880503144655),vec2(0.7044979079497908, 0.46331236897274636),vec2(0.7039748953974896, 0.46016771488469604),vec2(0.7024058577405857, 0.4549266247379455),vec2(0.7018828451882845, 0.45073375262054505),vec2(0.7018828451882845, 0.44863731656184486)]
    }, {
        "speed": 1,
        "path": [vec2(0.7139121338912134, 0.0010482180293501049), vec2(0.7154811715481172, 0.0031446540880503146), vec2(0.7170502092050209, 0.006289308176100629), vec2(0.7180962343096234, 0.009433962264150943), vec2(0.7201882845188284, 0.014675052410901468), vec2(0.7217573221757322, 0.020964360587002098), vec2(0.7238493723849372, 0.02620545073375262), vec2(0.725418410041841, 0.033542976939203356), vec2(0.7269874476987448, 0.039832285115303984), vec2(0.7306485355648535, 0.049266247379454925), vec2(0.7343096234309623, 0.06184486373165619), vec2(0.7384937238493724, 0.07861635220125786), vec2(0.7405857740585774, 0.0870020964360587), vec2(0.7421548117154811, 0.09224318658280922), vec2(0.7442468619246861, 0.10062893081761007), vec2(0.7468619246861925, 0.11006289308176101), vec2(0.7505230125523012, 0.12683438155136267), vec2(0.7510460251046025, 0.13731656184486374), vec2(0.752092050209205, 0.14465408805031446), vec2(0.7531380753138075, 0.1530398322851153), vec2(0.7547071129707112, 0.16352201257861634), vec2(0.7552301255230126, 0.1792452830188679), vec2(0.7557531380753139, 0.19916142557651992), vec2(0.7557531380753139, 0.20545073375262055), vec2(0.7557531380753139, 0.2148846960167715), vec2(0.7557531380753139, 0.22536687631027252), vec2(0.7557531380753139, 0.240041928721174), vec2(0.7557531380753139, 0.2557651991614256), vec2(0.7552301255230126, 0.2620545073375262), vec2(0.75418410041841, 0.27148846960167716), vec2(0.7531380753138075, 0.28197064989517817), vec2(0.7526150627615062, 0.2966457023060797), vec2(0.7515690376569037, 0.3113207547169811), vec2(0.7494769874476988, 0.3249475890985325), vec2(0.747907949790795, 0.33542976939203356), vec2(0.7473849372384938, 0.3448637316561845), vec2(0.74581589958159, 0.350104821802935), vec2(0.7442468619246861, 0.35429769392033544), vec2(0.7442468619246861, 0.3553459119496855), vec2(0.7426778242677824, 0.36477987421383645), vec2(0.7395397489539749, 0.3888888888888889), vec2(0.7343096234309623, 0.42348008385744235), vec2(0.7306485355648535, 0.4444444444444444), vec2(0.7264644351464435, 0.47064989517819705), vec2(0.7233263598326359, 0.48951781970649894), vec2(0.7217573221757322, 0.5020964360587002), vec2(0.7196652719665272, 0.5125786163522013), vec2(0.7170502092050209, 0.5230607966457023), vec2(0.7139121338912134, 0.5356394129979035), vec2(0.7102510460251046, 0.5482180293501048), vec2(0.7065899581589958, 0.5576519916142557), vec2(0.7013598326359832, 0.570230607966457), vec2(0.6976987447698745, 0.5807127882599581), vec2(0.6950836820083682, 0.589098532494759), vec2(0.6929916317991632, 0.5964360587002097), vec2(0.6903765690376569, 0.6016771488469602), vec2(0.6830543933054394, 0.6163522012578616), vec2(0.6778242677824268, 0.6236897274633124), vec2(0.6736401673640168, 0.6289308176100629), vec2(0.6694560669456067, 0.6320754716981132), vec2(0.6616108786610879, 0.6373165618448637), vec2(0.6506276150627615, 0.6457023060796646), vec2(0.6375523012552301, 0.6551362683438156), vec2(0.627092050209205, 0.6614255765199162), vec2(0.6171548117154811, 0.6666666666666666), vec2(0.6098326359832636, 0.6687631027253669), vec2(0.604602510460251, 0.6687631027253669), vec2(0.5930962343096234, 0.6687631027253669), vec2(0.5857740585774058, 0.6687631027253669), vec2(0.5810669456066946, 0.6677148846960168), vec2(0.5774058577405857, 0.6666666666666666), vec2(0.571652719665272, 0.6645702306079665), vec2(0.5664225941422594, 0.6624737945492662), vec2(0.5591004184100419, 0.6593291404612159), vec2(0.555439330543933, 0.6572327044025157), vec2(0.551255230125523, 0.6561844863731656), vec2(0.547071129707113, 0.6551362683438156), vec2(0.5423640167364017, 0.6551362683438156), vec2(0.5334728033472803, 0.6509433962264151), vec2(0.5287656903765691, 0.6509433962264151), vec2(0.5251046025104602, 0.649895178197065), vec2(0.5198744769874477, 0.6477987421383647), vec2(0.5120292887029289, 0.6457023060796646), vec2(0.5031380753138075, 0.6425576519916143), vec2(0.4952928870292887, 0.639412997903564), vec2(0.4884937238493724, 0.6352201257861635), vec2(0.48064853556485354, 0.629979035639413), vec2(0.47280334728033474, 0.6247379454926625), vec2(0.4675732217573222, 0.6184486373165619), vec2(0.4618200836820084, 0.6132075471698113), vec2(0.45292887029288703, 0.6016771488469602), vec2(0.4440376569037657, 0.5932914046121593), vec2(0.4382845188284519, 0.5880503144654088), vec2(0.4330543933054393, 0.5817610062893082), vec2(0.42416317991631797, 0.5754716981132075)]
    }, {
        "speed": 1,
        "path": [vec2(0, 0.5094339622641509), vec2(0, 0.5083857442348009), vec2(0, 0.5073375262054507), vec2(0.0005230125523012552, 0.5062893081761006), vec2(0.0031380753138075313, 0.5041928721174004), vec2(0.005753138075313808, 0.5020964360587002), vec2(0.00889121338912134, 0.4989517819706499), vec2(0.011506276150627616, 0.4968553459119497), vec2(0.015167364016736401, 0.4937106918238994), vec2(0.017259414225941423, 0.48951781970649894), vec2(0.019351464435146442, 0.48742138364779874), vec2(0.021443514644351465, 0.48532494758909855), vec2(0.024581589958158997, 0.4811320754716981), vec2(0.027719665271966527, 0.4779874213836478), vec2(0.03190376569037657, 0.4727463312368973), vec2(0.03347280334728033, 0.4716981132075472), vec2(0.0350418410041841, 0.469601677148847), vec2(0.03608786610878661, 0.46855345911949686), vec2(0.036610878661087864, 0.46855345911949686), vec2(0.03713389121338912, 0.46855345911949686), vec2(0.03765690376569038, 0.46855345911949686), vec2(0.038179916317991634, 0.46855345911949686), vec2(0.03922594142259414, 0.46750524109014674), vec2(0.0397489539748954, 0.46540880503144655), vec2(0.040271966527196654, 0.4643605870020964), vec2(0.04184100418410042, 0.46331236897274636), vec2(0.043410041841004186, 0.4612159329140461), vec2(0.04602510460251046, 0.4591194968553459), vec2(0.047594142259414225, 0.4570230607966457), vec2(0.049686192468619245, 0.45387840670859536), vec2(0.05282426778242678, 0.45178197064989517), vec2(0.05596234309623431, 0.44758909853249473), vec2(0.05700836820083682, 0.4444444444444444), vec2(0.05805439330543933, 0.44339622641509435), vec2(0.0596234309623431, 0.4412997903563941), vec2(0.060669456066945605, 0.4392033542976939), vec2(0.062238493723849375, 0.4350104821802935), vec2(0.06328451882845189, 0.4339622641509434), vec2(0.06433054393305439, 0.4308176100628931), vec2(0.06485355648535565, 0.429769392033543), vec2(0.06746861924686193, 0.4276729559748428), vec2(0.06956066945606694, 0.42348008385744235), vec2(0.07165271966527197, 0.42138364779874216), vec2(0.07269874476987448, 0.4192872117400419), vec2(0.07426778242677824, 0.41823899371069184), vec2(0.07688284518828452, 0.41509433962264153), vec2(0.07792887029288703, 0.4140461215932914), vec2(0.08002092050209204, 0.4119496855345912), vec2(0.08106694560669456, 0.40985324947589097), vec2(0.08211297071129707, 0.4088050314465409), vec2(0.08368200836820083, 0.40670859538784065), vec2(0.0852510460251046, 0.40461215932914046), vec2(0.08577405857740586, 0.4025157232704403), vec2(0.08838912133891214, 0.39832285115303984), vec2(0.0899581589958159, 0.3951781970649895), vec2(0.09205020920502092, 0.3941299790356394), vec2(0.09361924686192469, 0.3909853249475891), vec2(0.09518828451882845, 0.3888888888888889), vec2(0.09728033472803348, 0.3857442348008386), vec2(0.09832635983263599, 0.38469601677148846), vec2(0.09884937238493724, 0.38259958071278827), vec2(0.09989539748953975, 0.38155136268343814), vec2(0.100418410041841, 0.3805031446540881), vec2(0.10146443514644352, 0.37945492662473795), vec2(0.10303347280334728, 0.37735849056603776), vec2(0.10407949790794979, 0.37631027253668764), vec2(0.10460251046025104, 0.3752620545073375), vec2(0.10669456066945607, 0.3731656184486373), vec2(0.11035564853556486, 0.370020964360587), vec2(0.11140167364016737, 0.3689727463312369), vec2(0.11297071129707113, 0.3668763102725367), vec2(0.11558577405857741, 0.36477987421383645), vec2(0.11767782426778242, 0.36163522012578614), vec2(0.1202928870292887, 0.36058700209643607), vec2(0.12343096234309624, 0.35639412997903563), vec2(0.12447698744769875, 0.3553459119496855), vec2(0.1260460251046025, 0.3522012578616352), vec2(0.12813807531380753, 0.350104821802935), vec2(0.1297071129707113, 0.3480083857442348), vec2(0.13336820083682008, 0.34276729559748426), vec2(0.1354602510460251, 0.34067085953878407), vec2(0.13755230125523013, 0.3385744234800839), vec2(0.1401673640167364, 0.33542976939203356), vec2(0.14225941422594143, 0.33438155136268344), vec2(0.14330543933054393, 0.33228511530398325), vec2(0.14435146443514643, 0.3312368972746331), vec2(0.1459205020920502, 0.32914046121593293), vec2(0.1469665271966527, 0.3280922431865828), vec2(0.14748953974895398, 0.3280922431865828), vec2(0.14853556485355648, 0.3259958071278826), vec2(0.1506276150627615, 0.3238993710691824), vec2(0.15271966527196654, 0.3218029350104822), vec2(0.15481171548117154, 0.319706498951782), vec2(0.15690376569037656, 0.3165618448637317), vec2(0.1600418410041841, 0.31446540880503143), vec2(0.16213389121338911, 0.3113207547169811), vec2(0.16579497907949792, 0.30712788259958074), vec2(0.16736401673640167, 0.3060796645702306), vec2(0.16893305439330544, 0.3029350104821803), vec2(0.17102510460251047, 0.3008385744234801), vec2(0.17311715481171547, 0.29979035639413), vec2(0.17677824267782427, 0.29559748427672955), vec2(0.17730125523012552, 0.2945492662473795), vec2(0.17939330543933055, 0.29350104821802936), vec2(0.18148535564853557, 0.29245283018867924), vec2(0.18357740585774057, 0.2893081761006289), vec2(0.1856694560669456, 0.2882599580712788), vec2(0.18776150627615062, 0.28721174004192873), vec2(0.1893305439330544, 0.2861635220125786), vec2(0.18985355648535565, 0.2861635220125786), vec2(0.1903765690376569, 0.2861635220125786), vec2(0.19089958158995815, 0.2861635220125786), vec2(0.19142259414225943, 0.2851153039832285), vec2(0.19194560669456068, 0.2851153039832285), vec2(0.19299163179916318, 0.2840670859538784), vec2(0.19351464435146443, 0.2840670859538784), vec2(0.1940376569037657, 0.28197064989517817), vec2(0.1950836820083682, 0.2809224318658281), vec2(0.19717573221757323, 0.27882599580712786), vec2(0.19926778242677826, 0.27568134171907754), vec2(0.20135983263598325, 0.27253668763102723), vec2(0.20397489539748953, 0.2693920335429769), vec2(0.2065899581589958, 0.2641509433962264), vec2(0.20868200836820083, 0.2610062893081761), vec2(0.20972803347280336, 0.2589098532494759), vec2(0.21077405857740586, 0.2557651991614256), vec2(0.21234309623430964, 0.25471698113207547), vec2(0.21286610878661089, 0.25366876310272535), vec2(0.21443514644351463, 0.25052410901467503), vec2(0.2160041841004184, 0.24842767295597484), vec2(0.21652719665271966, 0.24737945492662475), vec2(0.2170502092050209, 0.24633123689727462), vec2(0.2175732217573222, 0.24528301886792453), vec2(0.2186192468619247, 0.24423480083857443), vec2(0.22280334728033474, 0.240041928721174), vec2(0.22384937238493724, 0.240041928721174), vec2(0.2243723849372385, 0.240041928721174), vec2(0.22489539748953974, 0.240041928721174)]
    }, {
        "speed": 1,
        "path": [vec2(0.9994769874476988, 0.34591194968553457), vec2(0.9973849372384938, 0.3448637316561845), vec2(0.9963389121338913, 0.3438155136268344), vec2(0.9947698744769874, 0.3438155136268344), vec2(0.9921548117154811, 0.3417190775681342), vec2(0.9911087866108786, 0.34067085953878407), vec2(0.9884937238493724, 0.34067085953878407), vec2(0.9879707112970711, 0.34067085953878407), vec2(0.9874476987447699, 0.33962264150943394), vec2(0.9858786610878661, 0.33962264150943394), vec2(0.9848326359832636, 0.33962264150943394), vec2(0.9843096234309623, 0.3385744234800839), vec2(0.9811715481171548, 0.33752620545073375), vec2(0.9806485355648535, 0.33752620545073375), vec2(0.9801255230125523, 0.33752620545073375), vec2(0.9790794979079498, 0.33752620545073375), vec2(0.9785564853556485, 0.33647798742138363), vec2(0.9769874476987448, 0.33542976939203356), vec2(0.9759414225941423, 0.33542976939203356), vec2(0.975418410041841, 0.33542976939203356), vec2(0.9743723849372385, 0.33542976939203356), vec2(0.9738493723849372, 0.33542976939203356), vec2(0.9733263598326359, 0.33542976939203356), vec2(0.9722803347280334, 0.33542976939203356), vec2(0.9717573221757322, 0.33542976939203356), vec2(0.9712343096234309, 0.33542976939203356), vec2(0.9701882845188284, 0.33438155136268344), vec2(0.9686192468619247, 0.33438155136268344), vec2(0.9675732217573222, 0.3333333333333333), vec2(0.9660041841004184, 0.3333333333333333), vec2(0.9628661087866108, 0.3312368972746331), vec2(0.9607740585774058, 0.330188679245283), vec2(0.9581589958158996, 0.3280922431865828), vec2(0.9560669456066946, 0.3270440251572327), vec2(0.9550209205020921, 0.3270440251572327), vec2(0.9524058577405857, 0.3259958071278826), vec2(0.9513598326359832, 0.3249475890985325), vec2(0.9503138075313807, 0.3238993710691824), vec2(0.9492677824267782, 0.3228511530398323), vec2(0.9476987447698745, 0.32075471698113206), vec2(0.9450836820083682, 0.31761006289308175), vec2(0.9429916317991632, 0.31551362683438156), vec2(0.9403765690376569, 0.31236897274633124), vec2(0.9372384937238494, 0.30922431865828093), vec2(0.9346234309623431, 0.30712788259958074), vec2(0.9330543933054394, 0.3050314465408805), vec2(0.9314853556485355, 0.3029350104821803), vec2(0.9293933054393305, 0.3008385744234801), vec2(0.9278242677824268, 0.29979035639413), vec2(0.926255230125523, 0.2976939203354298), vec2(0.924163179916318, 0.2966457023060797), vec2(0.9173640167364017, 0.29035639412997905), vec2(0.9100418410041841, 0.2861635220125786), vec2(0.9042887029288703, 0.2830188679245283), vec2(0.9011506276150628, 0.2809224318658281), vec2(0.897489539748954, 0.279874213836478), vec2(0.8922594142259415, 0.27672955974842767), vec2(0.8885983263598326, 0.2746331236897275), vec2(0.8828451882845189, 0.27044025157232704), vec2(0.8807531380753139, 0.26834381551362685), vec2(0.8786610878661087, 0.2672955974842767), vec2(0.8765690376569037, 0.2662473794549266), vec2(0.875, 0.2631027253668763), vec2(0.8734309623430963, 0.2620545073375262), vec2(0.8718619246861925, 0.2610062893081761), vec2(0.8692468619246861, 0.2578616352201258), vec2(0.8671548117154811, 0.2557651991614256), vec2(0.8655857740585774, 0.25366876310272535), vec2(0.8640167364016736, 0.2526205450733753), vec2(0.8619246861924686, 0.25052410901467503), vec2(0.8603556485355649, 0.24842767295597484), vec2(0.8582635983263598, 0.24633123689727462), vec2(0.856694560669456, 0.24528301886792453), vec2(0.8551255230125523, 0.2431865828092243), vec2(0.8535564853556485, 0.24213836477987422), vec2(0.8519874476987448, 0.24109014675052412), vec2(0.8478033472803347, 0.2358490566037736), vec2(0.8451882845188284, 0.2348008385744235), vec2(0.8420502092050209, 0.23270440251572327), vec2(0.8394351464435147, 0.23060796645702306), vec2(0.8362970711297071, 0.22746331236897274), vec2(0.8342050209205021, 0.22536687631027252), vec2(0.8326359832635983, 0.22431865828092243), vec2(0.8305439330543933, 0.22117400419287211), vec2(0.8284518828451883, 0.2190775681341719), vec2(0.8253138075313807, 0.21593291404612158), vec2(0.8232217573221757, 0.21278825995807127), vec2(0.8200836820083682, 0.20964360587002095), vec2(0.8174686192468619, 0.20754716981132076), vec2(0.8158995815899581, 0.20649895178197064), vec2(0.8143305439330544, 0.20440251572327045), vec2(0.8122384937238494, 0.20230607966457023), vec2(0.8117154811715481, 0.20125786163522014), vec2(0.8101464435146444, 0.20020964360587), vec2(0.8091004184100419, 0.19916142557651992), vec2(0.8080543933054394, 0.1970649895178197), vec2(0.8064853556485355, 0.1970649895178197), vec2(0.8043933054393305, 0.19392033542976939), vec2(0.8028242677824268, 0.1928721174004193), vec2(0.7996861924686193, 0.19077568134171907), vec2(0.797071129707113, 0.18867924528301888), vec2(0.7955020920502092, 0.18867924528301888), vec2(0.7934100418410042, 0.18658280922431866), vec2(0.7918410041841004, 0.18553459119496854), vec2(0.7892259414225942, 0.18553459119496854), vec2(0.7881799163179917, 0.18448637316561844), vec2(0.7866108786610879, 0.18238993710691823), vec2(0.7845188284518828, 0.18134171907756813), vec2(0.7829497907949791, 0.1792452830188679), vec2(0.7798117154811716, 0.17714884696016772), vec2(0.7777196652719666, 0.1761006289308176), vec2(0.7740585774058577, 0.17295597484276728), vec2(0.7719665271966527, 0.1719077568134172), vec2(0.770397489539749, 0.1719077568134172), vec2(0.7688284518828452, 0.1708595387840671), vec2(0.7672594142259415, 0.1708595387840671), vec2(0.7646443514644351, 0.16876310272536688), vec2(0.7635983263598326, 0.16771488469601678), vec2(0.7625523012552301, 0.16666666666666666)]
    }, {
        "speed": 1,
        "path": [vec2(0.2688284518828452, 0.0031446540880503146), vec2(0.26673640167364016, 0.008385744234800839), vec2(0.26464435146443516, 0.018867924528301886), vec2(0.2630753138075314, 0.027253668763102725), vec2(0.2615062761506276, 0.03249475890985325), vec2(0.25889121338912136, 0.041928721174004195), vec2(0.25523012552301255, 0.05241090146750524), vec2(0.2526150627615063, 0.06289308176100629), vec2(0.25, 0.07442348008385745), vec2(0.24790794979079497, 0.08490566037735849), vec2(0.24686192468619247, 0.09014675052410902), vec2(0.2452928870292887, 0.09538784067085954), vec2(0.24320083682008367, 0.10482180293501048), vec2(0.24110878661087867, 0.11425576519916142), vec2(0.2395397489539749, 0.12368972746331237), vec2(0.2384937238493724, 0.13417190775681342), vec2(0.23797071129707112, 0.14046121593291405), vec2(0.23692468619246862, 0.14360587002096437), vec2(0.23640167364016737, 0.1509433962264151), vec2(0.23587866108786612, 0.15723270440251572), vec2(0.2348326359832636, 0.16247379454926625), vec2(0.2348326359832636, 0.16981132075471697), vec2(0.2348326359832636, 0.1761006289308176), vec2(0.2337866108786611, 0.18658280922431866), vec2(0.23326359832635984, 0.19077568134171907), vec2(0.23274058577405857, 0.1960167714884696), vec2(0.23221757322175732, 0.20230607966457023), vec2(0.23169456066945607, 0.20754716981132076), vec2(0.23169456066945607, 0.2138364779874214), vec2(0.2301255230125523, 0.22536687631027252), vec2(0.2301255230125523, 0.23375262054507337), vec2(0.22960251046025104, 0.2379454926624738), vec2(0.22960251046025104, 0.24213836477987422), vec2(0.22960251046025104, 0.24528301886792453), vec2(0.2290794979079498, 0.25052410901467503), vec2(0.2280334728033473, 0.2620545073375262), vec2(0.2280334728033473, 0.2693920335429769), vec2(0.2280334728033473, 0.2777777777777778), vec2(0.2280334728033473, 0.2830188679245283), vec2(0.2280334728033473, 0.2882599580712788), vec2(0.2290794979079498, 0.29559748427672955), vec2(0.2290794979079498, 0.3008385744234801), vec2(0.2301255230125523, 0.3113207547169811), vec2(0.23064853556485357, 0.32075471698113206), vec2(0.23117154811715482, 0.3312368972746331), vec2(0.23169456066945607, 0.33752620545073375), vec2(0.23221757322175732, 0.3448637316561845), vec2(0.23274058577405857, 0.35429769392033544), vec2(0.23430962343096234, 0.36792452830188677), vec2(0.2348326359832636, 0.37735849056603776), vec2(0.23535564853556484, 0.389937106918239), vec2(0.23535564853556484, 0.3941299790356394), vec2(0.23587866108786612, 0.40041928721174), vec2(0.23587866108786612, 0.4056603773584906), vec2(0.23692468619246862, 0.4129979035639413), vec2(0.23901673640167365, 0.4276729559748428), vec2(0.2405857740585774, 0.4392033542976939), vec2(0.24110878661087867, 0.44549266247379454), vec2(0.24267782426778242, 0.45387840670859536), vec2(0.24581589958158995, 0.46226415094339623), vec2(0.2510460251046025, 0.4727463312368973), vec2(0.25627615062761505, 0.48532494758909855), vec2(0.25889121338912136, 0.49580712788259956), vec2(0.2615062761506276, 0.5052410901467506), vec2(0.26569037656903766, 0.5136268343815513), vec2(0.27405857740585776, 0.5241090146750524), vec2(0.28085774058577406, 0.5314465408805031), vec2(0.28451882845188287, 0.5345911949685535), vec2(0.2860878661087866, 0.5387840670859538), vec2(0.28765690376569036, 0.5408805031446541), vec2(0.29027196652719667, 0.5461215932914046), vec2(0.2928870292887029, 0.550314465408805), vec2(0.30073221757322177, 0.559748427672956), vec2(0.30857740585774057, 0.5681341719077568), vec2(0.3138075313807531, 0.5744234800838575), vec2(0.32583682008368203, 0.5838574423480084), vec2(0.32792887029288703, 0.5838574423480084), vec2(0.3305439330543933, 0.5838574423480084), vec2(0.33158995815899583, 0.5838574423480084), vec2(0.33368200836820083, 0.5838574423480084), vec2(0.33472803347280333, 0.5838574423480084), vec2(0.3410041841004184, 0.5838574423480084), vec2(0.34309623430962344, 0.5838574423480084), vec2(0.34518828451882844, 0.5838574423480084), vec2(0.3530334728033473, 0.5838574423480084), vec2(0.3561715481171548, 0.5838574423480084), vec2(0.36297071129707115, 0.5807127882599581), vec2(0.36715481171548114, 0.5786163522012578), vec2(0.3713389121338912, 0.5765199161425576), vec2(0.3807531380753138, 0.5691823899371069), vec2(0.3875523012552301, 0.5649895178197065), vec2(0.3912133891213389, 0.5639412997903563), vec2(0.3948744769874477, 0.5628930817610063), vec2(0.40010460251046026, 0.560796645702306), vec2(0.40794979079497906, 0.5545073375262054), vec2(0.41527196652719667, 0.550314465408805), vec2(0.41841004184100417, 0.5482180293501048), vec2(0.4205020920502092, 0.5450733752620545), vec2(0.42311715481171547, 0.5440251572327044), vec2(0.4252092050209205, 0.5419287211740041), vec2(0.4273012552301255, 0.5408805031446541), vec2(0.4299163179916318, 0.5366876310272537), vec2(0.4361924686192469, 0.5303983228511531), vec2(0.44037656903765693, 0.5262054507337526), vec2(0.4429916317991632, 0.5241090146750524), vec2(0.4456066945606695, 0.5167714884696016), vec2(0.4476987447698745, 0.5115303983228512), vec2(0.45083682008368203, 0.4989517819706499), vec2(0.4524058577405858, 0.49266247379454925), vec2(0.4534518828451883, 0.48742138364779874), vec2(0.45502092050209203, 0.48218029350104824), vec2(0.45763598326359833, 0.4727463312368973), vec2(0.46077405857740583, 0.46226415094339623), vec2(0.46443514644351463, 0.45073375262054505), vec2(0.46809623430962344, 0.4412997903563941), vec2(0.47123430962343094, 0.4276729559748428), vec2(0.473326359832636, 0.42138364779874216), vec2(0.473326359832636, 0.4161425576519916), vec2(0.4743723849372385, 0.40670859538784065), vec2(0.4743723849372385, 0.39937106918238996), vec2(0.47489539748953974, 0.38784067085953877), vec2(0.475418410041841, 0.3805031446540881), vec2(0.475418410041841, 0.370020964360587), vec2(0.475418410041841, 0.3637316561844864), vec2(0.475418410041841, 0.35953878406708595), vec2(0.475418410041841, 0.3522012578616352), vec2(0.47489539748953974, 0.3438155136268344), vec2(0.4743723849372385, 0.3333333333333333), vec2(0.47384937238493724, 0.3259958071278826), vec2(0.47280334728033474, 0.32075471698113206), vec2(0.4707112970711297, 0.31446540880503143), vec2(0.47018828451882844, 0.3113207547169811), vec2(0.4696652719665272, 0.30922431865828093), vec2(0.4675732217573222, 0.3029350104821803), vec2(0.4665271966527197, 0.29874213836477986), vec2(0.4660041841004184, 0.2976939203354298), vec2(0.46548117154811713, 0.2966457023060797)]
    }
]
PathIndex = {
    "STAGE_1_MINION_LEFT": 0,
    "STAGE_1_MINION_RIGHT": 1,
    "STAGE_2_MINION_RIGHT": 2,
    "STAGE_2_BUTTERFLU_LEFT": 3,
    "STAGE_2_BUTTERFLU_RIGHT": 4,
    "STAGE_2_MINION_LEFT": 5
}

stage_start_time = 0
level_stages = [
    {
        "top_left": vec2(0.25, 0.15), # clipspace
        "bottom_right": vec2(0.75, 0.45), # clipspace
        "stage_offset": vec2(0, 0), # actual coordinates
        "minion_positions_pool": [ # relative to stage
            vec2(0, 0.5), vec2(0.125, 0.5), vec2(0.25, 0.5), vec2(0.375, 0.5), vec2(0.5, 0.5), vec2(0.625, 0.5), vec2(0.75, 0.5), vec2(0.875, 0.5), vec2(1, 0.5),
            vec2(0, 1), vec2(0.125, 1), vec2(0.25, 1), vec2(0.375, 1), vec2(0.5, 1), vec2(0.625, 1), vec2(0.75, 1), vec2(0.875, 1), vec2(1, 1),
        ],
        "butterflu_positions_pool": [
            vec2(0.2, 0), vec2(0.4, 0), vec2(0.6, 0), vec2(0.8, 0)
        ], 
        "mothership_positions_pool": []
    }, {
        "top_left": vec2(0.05, 0.05),
        "bottom_right": vec2(0.95, 0.6),
        "stage_offset": vec2(0, 0),
        "minion_positions_pool": [
            vec2(0, 1), vec2(1/7, 1), vec2(2/7, 1), vec2(3/7, 1), vec2(4/7, 1), vec2(5/7, 1), vec2(6/7, 1), vec2(1, 1),

            vec2(1/14, 5/6), vec2(3/14, 5/6), vec2(5/14, 5/6), vec2(7/14, 5/6), vec2(9/14, 5/6), vec2(11/14, 5/6), vec2(13/14, 5/6),

            vec2(0, 4/6), vec2(1/14, 4/6), vec2(2/14, 4/6), vec2(3/14, 4/6), vec2(4/14, 4/6), vec2(5/14, 4/6), vec2(6/14, 4/6), vec2(7/14, 4/6), vec2(8/14, 4/6), vec2(9/14, 4/6), vec2(10/14, 4/6), vec2(11/14, 4/6), vec2(12/14, 4/6), vec2(13/14, 4/6), vec2(1, 4/6),
        ],
        "butterflu_positions_pool": [
            vec2(3/28,  3/6), vec2(3/28,  2/6), vec2(3/28,  1/6), vec2(3/28,  0),
            vec2(7/28,  3/6), vec2(7/28,  2/6), vec2(7/28,  1/6), vec2(7/28,  0), 
            vec2(11/28, 3/6), vec2(11/28, 2/6), vec2(11/28, 1/6), vec2(11/28, 0), 
            vec2(25/28, 3/6), vec2(25/28, 2/6), vec2(25/28, 1/6), vec2(25/28, 0), 
            vec2(21/28, 3/6), vec2(21/28, 2/6), vec2(21/28, 1/6), vec2(21/28, 0), 
            vec2(17/28, 3/6), vec2(17/28, 2/6), vec2(17/28, 1/6), vec2(17/28, 0) 
        ], 
        "mothership_positions_pool": []
    }
]
current_level_stage = 0

class Enemy(Entity):
    enemy_behavior = EnemyBehavior.IN_PATH
    path_index = 0
    path_tick = 0
    stage_offset = vec2(0, 0)
    stage_index = 0
    attack_delay = 0

#  _ _
# \ ^ /
#  /_\
class Minion(Enemy):
    texture = """ _ _ 
\ ^ /
 /_\ """
    texture_dimensions = vec2(5, 3)
    bulletproof = False
    health = 2

#  _  _
# { || }
# [_||_]
class Butterflu(Enemy):
    texture = """ _  _ 
{ || }
[_||_]"""
    texture_dimensions = vec2(6, 3)
    bulletproof = False
    health = 3
    charge_direction = vec2(0, 0)

#  _   _
# | |_| |
#  \ O /
#   | |
#   *^*
class Mothership(Enemy):
    texture = """ _   _
| |_| |
 \ O / 
  | |  
  *^*  """
    texture_dimensions = vec2(7, 5)
    bulletproof = False
    health = 5

#     \_/
#    \___/
#   \_____/
#  \_______/
# \_________/
class Motherbeam(Entity):
    texture = """    \_/    
   \___/   
  \_____/  
 \_______/ 
\_________/"""
    texture_dimensions = vec2(13, 5)
    penetration = 1

debug_message = ""

key_down = {
    "up": False,
    "down": False,
    "left": False,
    "right": False,
    "space": False
}
key_just_down = {
    "space": False
}
last_keydown = False
last_go_right = False

def handle_keydown(key, is_injected):
    global key_down
    global last_keydown

    last_keydown = key

    if (key == pynput.keyboard.Key.up):
        key_down['up'] = True 
    if (key == pynput.keyboard.Key.down):
        key_down['down'] = True 
    if (key == pynput.keyboard.Key.left):
        key_down['left'] = True 
    if (key == pynput.keyboard.Key.right):
        key_down['right'] = True 
    if (key == pynput.keyboard.Key.space):
        if not key_down['space']:
            key_just_down['space'] = True 
        key_down['space'] = True

def handle_keyup(key, is_rejected):
    if (key == pynput.keyboard.Key.up):
        key_down['up'] = False 
    if (key == pynput.keyboard.Key.down):
        key_down['down'] = False 
    if (key == pynput.keyboard.Key.left):
        key_down['left'] = False 
    if (key == pynput.keyboard.Key.right):
        key_down['right'] = False 
    if (key == pynput.keyboard.Key.space):
        key_down['space'] = False

keystroke_handler = pynput.keyboard.Listener(
    on_press=handle_keydown,
    on_release=handle_keyup
)
keystroke_handler.start()

player = Starfighter(curses.COLS // 2 - 1, curses.LINES - 8)
player.identification = "ws0k3"

# monster = Minion(curses.COLS // 2 - 1, 10)
# monster.identification = "m0n3r"

class Scene(Enum):
    START = "start scene"
    PLAY = "play scene"
current_scene = Scene.START

def release_key_just_down():
    for key in key_just_down.keys():
        key_just_down[key] = False

def handle_player():
    global player

    if player.health > 0:
        control_player()
    else:
        player.layout.layer_visibility[0] = False
        player.layout.layer_visibility[1] = False
        player.layout.layer_visibility[2] = False


recoil = 0
def control_player():
    global recoil
    global player
    player_speed = vec2(1, 0.5)

    # if key_down['up']:
    #     player.position.y -= player_speed.y
    # if key_down['down']:
    #     player.position.y += player_speed.y
    if key_down['right']:
        player.position.x += player_speed.x
    if key_down['left']:
        player.position.x -= player_speed.x
        
        
    if recoil > 0:
        recoil -= 1
    elif key_just_down["space"]:
        x_pos = player.position.x + 0.5
        y_pos = round(player.position.y - 1)
 
        new_bullet = Bullet(x_pos, y_pos)
        new_bullet.pointing_up = True
        new_bullet.identification = "b214"

        recoil = 3

def simulate_bullet(bullet):
    global entity_buffer
    global bullets_buffer
    global debug_message

    hit = False
    for enemy in entity_buffer:
        if enemy.identification == "ws0k3" and bullet.identification == "b214":
            continue
        if enemy.identification != "ws0k3" and bullet.identification != "b214":
            continue
        if enemy.identification == bullet.identification: # we can't use pointing up because it's not guaranteed to be a property
            continue

        if bullet.is_colliding(enemy):
            hit = True
            enemy.health -= 1
            
            # debug_message = f"bullet {bullet.identification} hit enemy {enemy.identification}"
            # debug_message = f"{enemy.identification == "ws0k3" and bullet.identification == "b124"}"

    if bullet.position.y < 0 or bullet.position.y > curses.LINES or hit:
        bullet.health = 0

    if bullet.pointing_up:
        bullet.position.y -= 1
    else:
        bullet.position.y += 1

def handle_enemies(current_enemy):
    global debug_message
    global player
    # current_enemy.position = vec2(0.0006527415143603133, 0.6771488469601677).multiply(vec2(curses.COLS, curses.LINES))
    # debug_message = f"x: {current_enemy.position.x} y: {current_enemy.position.y}"

    if current_enemy.enemy_behavior == EnemyBehavior.IN_PATH:
        current_enemy.position = paths[current_enemy.path_index]['path'][current_enemy.path_tick].calc_multiply(vec2(curses.COLS, curses.LINES))
        current_enemy.path_tick += paths[current_enemy.path_index]['speed']
        
        if current_enemy.path_tick >= len(paths[current_enemy.path_index]['path']):
            current_enemy.enemy_behavior = EnemyBehavior.GOING_TO_LINE

    if current_enemy.stage_index != current_level_stage:
        current_enemy.stage_index = current_level_stage
        current_enemy.attack_delay = 180
        
        if isinstance(current_enemy, Minion):
            current_enemy.stage_offset = level_stages[current_level_stage]['minion_positions_pool'].pop(random.randint(0, len(level_stages[current_level_stage]['minion_positions_pool']) - 1))
            
        if isinstance(current_enemy, Butterflu):
            current_enemy.stage_offset = level_stages[current_level_stage]['butterflu_positions_pool'].pop(random.randint(0, len(level_stages[current_level_stage]['butterflu_positions_pool']) - 1))

    if current_enemy.enemy_behavior == EnemyBehavior.GOING_TO_LINE:
        top_left = level_stages[current_level_stage]['top_left']
        bottom_right = level_stages[current_level_stage]['bottom_right']
        stage_offset = level_stages[current_level_stage]['stage_offset']

        # I don't know how to do a cleaner way of custom stage offsets
        if current_level_stage == 1:
            personal_time = current_enemy.stage_offset.x + current_enemy.stage_offset.y + time.time()
            personal_time *= 5
            stage_offset = vec2(math.sin(personal_time), math.sin(personal_time)).multiply(3)

        # if isinstance(current_enemy, Minion):
        #     debug_message = f"stage offset: {stage_offset}"

        target_position = current_enemy.stage_offset.calc_multiply(bottom_right.calc_substr(top_left)).add(top_left)
        target_position.multiply(vec2(curses.COLS, curses.LINES)).add(stage_offset)

        delta = target_position.calc_substr(current_enemy.position)
        distance = delta.length()
        
        if distance > 0.5:
            unit_delta = delta.divide(distance * 2)
            current_enemy.position.add(unit_delta)
            # debug_message = f"target: {level_stages[current_enemy.stage_index]} unit delta: {unit_delta}"

    if current_enemy.attack_delay > 0:
        current_enemy.attack_delay -= 1
    elif isinstance(current_enemy, Minion):
        if random.random() < 0.01:
            minion_bullet = Bullet(current_enemy.position.x, current_enemy.position.y + 2)
            minion_bullet.pointing_up = False
    elif isinstance(current_enemy, Butterflu):
        if current_enemy.enemy_behavior == EnemyBehavior.GOING_TO_LINE and random.random() < 0.001:
            unit_delta = player.position.calc_substr(current_enemy.position)
            unit_delta.divide(unit_delta.length())
            
            current_enemy.charge_direction = unit_delta
            current_enemy.enemy_behavior = EnemyBehavior.ATTACKING
            # debug_message = f"enemy {current_enemy.identification} is charging at player"
        
        if current_enemy.enemy_behavior == EnemyBehavior.ATTACKING:
            current_enemy.position.add(current_enemy.charge_direction)
            
            if current_enemy.is_colliding(player):
                player.health -= 3
                current_enemy.health = 0
            
            if current_enemy.position.y > curses.LINES + current_enemy.texture_dimensions.y:
                current_enemy.position = vec2(curses.COLS/2, -3)
                current_enemy.attack_delay = 180
                current_enemy.enemy_behavior = EnemyBehavior.GOING_TO_LINE
                

minion_spawn_delay = 0
minion_spawn_path = PathIndex['STAGE_1_MINION_LEFT']
butterflu_spawn_delay = 0
butterflu_spawn_path = PathIndex['STAGE_2_BUTTERFLU_LEFT']
def stage_controller():
    global debug_message

    global minion_spawn_delay
    global minion_spawn_path
    global butterflu_spawn_delay
    global butterflu_spawn_path

    global stage_start_time
    global level_stages
    global current_level_stage

    current_stage = level_stages[current_level_stage]
    minion_pool_size = len(current_stage['minion_positions_pool'])
    butterflu_pool_size = len(current_stage['butterflu_positions_pool'])

    if current_level_stage == 0:
        if minion_pool_size > 0:
            if minion_spawn_delay > 0:
                minion_spawn_delay -= 1
            else:
                new_minion = Minion()
                new_minion.path_index = minion_spawn_path
                new_minion.stage_offset = level_stages[current_level_stage]['minion_positions_pool'].pop(random.randint(0, minion_pool_size - 1))
                new_minion.stage_index = 0
                new_minion.attack_delay = 180

                minion_spawn_delay = 8
                
                if minion_spawn_path == PathIndex['STAGE_1_MINION_LEFT']:
                    minion_spawn_path = PathIndex['STAGE_1_MINION_RIGHT']
                else:
                    minion_spawn_path = PathIndex['STAGE_1_MINION_LEFT']

        if butterflu_pool_size > 0:
            if butterflu_spawn_delay > 0:
                butterflu_spawn_delay -= 1
            else:
                new_butterflu = Butterflu(curses.COLS/2, 0)
                new_butterflu.enemy_behavior = EnemyBehavior.GOING_TO_LINE
                new_butterflu.stage_offset = level_stages[current_level_stage]['butterflu_positions_pool'].pop(random.randint(0, butterflu_pool_size - 1))
                new_butterflu.stage_index = 0
                new_butterflu.attack_delay = 300

                butterflu_spawn_delay = 8
        
        current_stage['stage_offset'] = vec2(math.sin(time.time())*4, math.sin(time.time()*2))
        if time.time() - stage_start_time > 30:
            current_level_stage = 1
            minion_spawn_delay = 0
            minion_spawn_path = 2
    
    if current_level_stage == 1:
        if minion_pool_size > 0:
            if minion_spawn_delay > 0:
                minion_spawn_delay -= 1
            else:
                new_minion = Minion()
                new_minion.path_index = minion_spawn_path
                new_minion.stage_offset = level_stages[current_level_stage]['minion_positions_pool'].pop(random.randint(0, minion_pool_size - 1))
                new_minion.stage_index = 1
                new_minion.attack_delay = 180

                minion_spawn_delay = 8
                
                if minion_spawn_path == PathIndex['STAGE_2_MINION_RIGHT']:
                    minion_spawn_path = PathIndex['STAGE_2_MINION_LEFT']
                else:
                    minion_spawn_path = PathIndex['STAGE_2_MINION_RIGHT']
        
        if butterflu_pool_size > 0:
            if butterflu_spawn_delay > 0:
                butterflu_spawn_delay -= 1
            else:
                new_butterflu = Butterflu()
                new_butterflu.path_index = 3
                new_butterflu.stage_offset = level_stages[current_level_stage]['butterflu_positions_pool'].pop(random.randint(0, butterflu_pool_size - 1))
                new_butterflu.stage_index = 1
                new_butterflu.attack_delay = 300

                butterflu_spawn_delay = 8
                
                if butterflu_spawn_path == PathIndex['STAGE_2_BUTTERFLU_LEFT']:
                    butterflu_spawn_path = PathIndex['STAGE_2_BUTTERFLU_RIGHT']
                else:
                    butterflu_spawn_path = PathIndex['STAGE_2_BUTTERFLU_LEFT']


def tick(stdscr):
    global current_scene
    global entity_buffer
    global stage_start_time

    if current_scene == Scene.PLAY:
        handle_player()
        
        max_index = len(entity_buffer)
        current_index = 1
        while current_index < max_index:
            thing = entity_buffer[current_index]
            
            if thing.health <= 0:
                entity_buffer.pop(current_index)
                max_index -= 1 
                current_index -= 1
                continue

            if isinstance(thing, Bullet):
                simulate_bullet(thing)
                
            if isinstance(thing, Enemy):
                handle_enemies(thing)
            
            current_index += 1
        
        stage_controller()

    if current_scene == Scene.START:
        if key_just_down["space"]:
            stage_start_time = time.time()
            current_scene = Scene.PLAY
    
    release_key_just_down()

def draw_start_scene(stdscr):
    title = ["                   Yapheth Stephan Nathaniel's re-enacment of                   ",
             "     ___           ___           ___       ___           ___           ___      ",
             "    /\  \         /\  \         /\__\     /\  \         /\  \         /\  \     ",
             "   /::\  \       /::\  \       /:/  /    /::\  \       /::\  \       /::\  \    ",
             "  /:/\:\  \     /:/\:\  \     /:/  /    /:/\:\  \     /:/\:\  \     /:/\:\  \   ",
             " /:/  \:\  \   /::\~\:\  \   /:/  /    /::\~\:\  \   /:/  \:\  \   /::\~\:\  \  ",
             "/:/__/_\:\__\ /:/\:\ \:\__\ /:/__/    /:/\:\ \:\__\ /:/__/_\:\__\ /:/\:\ \:\__\ ",
             "\:\  /\ \/__/ \/__\:\/:/  / \:\  \    \/__\:\/:/  / \:\  /\ \/__/ \/__\:\/:/  / ",
             " \:\ \:\__\        \::/  /   \:\  \        \::/  /   \:\ \:\__\        \::/  /  ",
             "  \:\/:/  /        /:/  /     \:\  \       /:/  /     \:\/:/  /        /:/  /   ",
             "   \::/  /        /:/  /       \:\__\     /:/  /       \::/  /        /:/  /    ",
             "    \/__/         \/__/         \/__/     \/__/         \/__/         \/__/     "]
    dimensions = vec2(80, 12)
    top_left = vec2(curses.COLS, curses.LINES).substr(dimensions).calc_divide(2).calc_to_int()

    for index in range(dimensions.y):
        stdscr.addstr(top_left.y + index, top_left.x, title[index])

    if (time.time()*1000)%1000 < 500:
        stdscr.addstr(top_left.y + dimensions.y, top_left.x + dimensions.x//2 - 10, "Press SPACE To Start")

def draw_hud(stdscr):
    global player

    stdscr.addstr(curses.LINES - 3, curses.COLS - 45, "REMAINING HEALTH:")

    ascii_art = """ _ _ _ _ _ _ _ _ _ _ _
/"""
# /_/_/_/_/_/_/_/_/_ _ _ /"""
    ascii_art += "_/" * player.health + "_ " *  min(10 - player.health, 10) + "_/"
    health_hud_layout = layout(ascii_art)
    # print(ascii_art)
    health_hud_layout.draw_at(stdscr, curses.LINES - 4, curses.COLS - 26)

def draw_entities_from_buffer(stdscr):
    for entity in entity_buffer:
    #     if entity.identification == "m0n3r":
    #         debug_message = f"monster x: {entity.position.x}"

        top_left_x = entity.position.x - entity.texture_dimensions.x / 2
        top_left_y = entity.position.y - entity.texture_dimensions.y / 2
        
        entity.layout.draw_at(stdscr, round(top_left_y), round(top_left_x))

def render(stdscr):
    stdscr.clear()

    draw_entities_from_buffer(stdscr)

    global player
    # bullet_id = ""
    # if len(bullets_buffer) > 0:
    #     bullet_id = f"bullet identification: {bullets_buffer[0].identification}"
    # else:
    #     bullet_id = "no bullets yet"

    global current_scene
    if current_scene == Scene.START:
        draw_start_scene(stdscr)
    if current_scene == Scene.PLAY:
        draw_hud(stdscr)
    
    stdscr.addstr(curses.LINES - 1, 0, f"debug: {debug_message} | buffer size: {len(entity_buffer)}")

    stdscr.refresh()

def main(stdscr):
    stdscr.clear()
    curses.noecho()
    curses.cbreak()
    stdscr.keypad(True)
    stdscr.nodelay(True)
    
    while True:
        tick(stdscr)
        render(stdscr)
        time.sleep(0.016667)

curses.wrapper(main)